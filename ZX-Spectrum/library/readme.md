Общие правила и рекомендации по разработке функций нашей библиотеки на ассемблере для платформы ZX Spectrum.

Директория содержит файлы функций, примеров их использования и этот файл описания правил редактирования и использования библиотеки.

Библиотека в целом и каждый отдельный файл, содержащиеся в данной директории использует лицензию Creative Commons. Внесение дополнений, изменений и иных правок - означает автоматическое согласие с лицензией Creative Commons и последющее использование кода в рамках данной лицензии. Библиотека поставляется как есть, служит образовательным и культурным целям, работоспособность ни в каком виде не гарантируется.

Базовые требования по железу совпадают с минимальной платформой оригинального ZX Spectrum 48K или плоская простая модель, если функция именно требует другой конфигурации, то это нужно обязательно указать в описании.

Общие правила для всех кто разрабатывает функции или будет править те, что уже есть.

Стараемся придерживаться одного стиля и этих правил, чтобы разработка шла комфортно для разных конфигураций, как реальных машин или эмуляторов, так и различных ассемблеров и сред разработки.

В директории все функции организованы по алфавиту, имена малыми буквами и знаками подчеркивания, длина имени не ограничена, но в пределах разумного. Кодировка файлов UTF-8, для читабельности, если ваш инструмент не поддерживает её, то всегда можно конвертировать в нужную кодировку, будьте внимательны. Большая универсальная функций именуюется просто именем, без дополнительных слов в конце. Остальные версии одинаковых функций должны дополнятся ключевым словом в конце, отражающим отличие версии. Например:

print_string.asm - универсальная, безопасная с точки зрения сохранения состояния всех регистров, флагов и остальной памяти, кроме своей статичной и как правило, не самая быстрая версия функции печати строки;

print_string_unsafe.asm - функция которая не сохраняет состояние регистров, флагов или памяти вне пределов своей статичной области, точно таким же, каким оно было до вызова и что именно функция меняет при исполнении, требуется указать в комментариях;

print_string_fast.asm - функция которая безопасна с точки зрения вызова, но ограничена по функциоаналу и возможно без проверок, но быстрая.

Немного о типах памяти, которая может быть задействована:

Регистры процессора, их можно использовать полностью, включая альтернативный набор, с учетом сохранения их состояния сразу после вызова и восстановлением перед возвратом в основной код.

Статическая память, которая требуется для функции между вызовами или для инициализации. Статичных данных должно быть минимум, чтобы не тянуть за собой большие бинарные данные и не увеличивать сверх необходимого затраты на память.

Динамическая память, которая требуется временно функции на время вызова или является частью функционала. Этот вид памяти должен быть выделен за пределами самой функции и на вход уже должен придти адрес достаточно свободного блока, в который допустима запись данных. Все параметры и требования прописать в документации обязательно.

Динамическая память, которая вынужденно выделяется по заданным адресам или используюся определенные, уже жестко заданные адреса и другого варианта решения нету. Подобный вариант может быть только в крайнем случае, полностью документирован и если есть возможность, то заданы константные настройки, которые позволят менять данные параметры, функция автоматически должна быть с именем в конце "_unsafe";

Функции могут использовать в качестве включаемых файлов только файлы из этой же библиотеки, находящиеся в текущей директории и они должны быть самодостаточны, т.е. внешние ссылки пока что не допускаются. Бинарные данные не вставлять. Возможно что в будущем этот пункт будет изменен.

Для файлов, содержащими примеры, использования библиотеки - оформление и выбор инструментов свободный, но лучше будет если указать, то что требуется для сборки и запуска демонстрации или примера.

В самой библиотечной функции необходимо придерживаться строгого стиля написания команд процессора Zilog Z80, которые были в официальной документации. Не использовать сокращенные команды, которые поддерживаются не всеми ассемблерами. Не использовать макросы, пишем команды полностью.

При использовании меток, дополнять названия символом ":", т.к. многие ассемблеры этого требовали и не превышать размеры меток в условные 16 символов, или если совсем кратко, то и 8 символов.

Далее общие пожелания по стилю оформления, которых желательно придерживаться, чтобы редактирование и правка кода была максимально комфортной для всех:

Комментарии - это часть кода на ассемблере, в отличии от языков программирования высокого уровня, крайне затратно по времени изучать код и пытаться одновременно понять мысль автора. Поэтому подробное описане функции и комментарии, пусть краткие и не на каждой строчке, но они должны быть. Если комментарий достаточно длинный, то его можно записать отдельной строкой прямо с начала. Для комментариев используем только символ ";", т.к. это минимально поддерживается почти всеми ассемблерами.

По ширине строки именно для Спектрума мы ориентируемся на стандартные режимы отображения текста: 32 символа как и в Бейсике, но это скромно, 42 символа достаточно хороший параметр по соотношению читабельности и объема текста на экране. Ну и ширину свыше 64 символов лучше не использовать, или максимум там могут быть комментарии.

Если функция использует структуру данных, то её необходимо положить в один файл вместе с функцией, и если можно, то дополнить комментарием не только по данным, но и подписывать смещения относительно старта этой функции.

Форматы задания данных лучше придерживаться стандартных и полных обозначений, DEFB - определение байта, DEFW - определение слова и если поддерживается, то и DEFQ - для длинного слова. Для сообщений и текстового формата лушче использовать простой DEFB с кавычками.

И общий совет по декомпозиции, одна функция может быть достаточно малой, но должна быть логически не противоречивой единицей, которую потом можно удерживая в голове продолжить процесс разрешения функций более высокого порядка.

Также стоит еще учитывать в уме, т.к. у нас ретро-платформа, это примерную производительность и занимаемый объем по памяти.

Базовый формат строки для функций связанных с обработкой текста и сообщений.

Т.к. использовать классический формат с признаком окончания строки может быть накладно по проиозводительности, то мы сохраним еще минимальный объем информации о строке в самом её начале и оставим простор для доработки или дополнительных параметров, для более сложных функций.  

В нулевой байт мы по традиции сохраним актульную длину строки от 0 до 254, а вот вторым байтом или смещением +1, мы сохраним смещение старта самого текста. Т.е. если начало текста строки задать в смещение +7 например, то пространство строки от +2 до +6-ое смещение, автоматически становится дополнительным и его можно использовать для своих параметров функции.

Длина уже точно не будет больше 256 байт вместе со всей информацей о строке, чтобы легче написать код, а для длинных текстов или потоков, возможно стоит использовать что-то другое или разбить на несколько строк.

Формат смещений, в байтах, или 8-битах, за резервирования памяти под строку отвечает внешний код:
[0]     	актуальная длина строки, от 0 до 254 или менее, в зависимости от смещения начала текста;
[1]     	смещение начала текста, по умолчанию равно 2, и следующий за этим байт, уже является текстом.
[2..255]	сам текст строки, если в [1] не указано другое смещение, то [2..ТЕКСТ] содержаться дополнительные параметры для функции.
